# Comad J CAR 시스템 데이터베이스 스키마 정의서 (Prisma 기반)

> 최종 수정일: 2025-06-20
> 작성자: TECH ME Comad J
> 업데이트: 구현 완료 기준 최종본

> 이 문서는 실제 구현된 Prisma ORM 스키마와 최신 AI 분석/제언 파이프라인 정책을 기준으로 작성되었습니다.

---

## 1. 초기 데이터 구성 (CSV 기반)

* 초기 데이터는 `UPLOAD_TEMPLATE_UTF8.csv` 파일을 기준으로 구성됨
* 웹 UI 입력이 아닌 마이그레이션 방식으로만 적용
* 필드 매핑 기준은 CAR 모델 구조와 동일함
* Prisma seed script (`prisma/seed.ts`) 사용하여 일괄 삽입

---

## 2. 모델 정의

### User 모델

```ts
model User {
  id                Int      @id @default(autoincrement())
  loginId           String   @unique
  password          String
  role              Role
  name              String
  department        String
  email             String?
  weeklyReportEmail Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  cars              CAR[]    @relation("CreatedCars")
}
```

> **주요 추가 필드**:
> - `email`: 사용자 이메일 주소 (선택)
> - `weeklyReportEmail`: 주간 보고서 메일 수신 여부

### CAR 모델

```ts
model CAR {
  id                  Int      @id @default(autoincrement())
  corporation         String   // 우리회사(Comad J) 지사 구분

  eventType           EventType
  issueDate           BigInt   // timestamp로 저장
  dueDate             BigInt?  // timestamp로 저장
  importance          Float

  internalContact     String?
  receptionChannel    String?
  mainCategory        String?
  openIssue           String?
  followUpPlan        String?
  completionDate      BigInt?  // timestamp로 저장

  internalScore       Float?
  customerScore       Float?
  subjectiveScore     Float?
  score               Float?

  sentimentScore      Float?
  aiKeywords          String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  createdBy           Int
  creator             User     @relation("CreatedCars", fields: [createdBy], references: [id])

  scoreHistories      ScoreHistory[]
  carCustomerContacts CarCustomerContact[]
}
```

> **주요 변경사항**:
> - 날짜 필드를 `BigInt` 타입으로 변경 (timestamp 저장)
> - 고객 관계를 N:M 관계로 변경 (`CarCustomerContact` 중간 테이블 사용)
> - `corporation` 필드는 Comad J 지사 구분용으로 사용


### ScoreHistory 모델

```ts
model ScoreHistory {
  id        Int      @id @default(autoincrement())
  carId     Int
  car       CAR      @relation(fields: [carId], references: [id])
  scoreType String
  value     Float
  createdAt DateTime @default(now())
}
```

### CustomerContact 모델

```ts
model CustomerContact {
  id                  Int      @id @default(autoincrement())
  name                String
  group               String   // 고객사 그룹
  company             String?
  department          String
  phone               String
  memo                String?
  createdAt           DateTime @default(now())

  carCustomerContacts CarCustomerContact[]
}
```

### CarCustomerContact 모델 (N:M 중간 테이블)

```ts
model CarCustomerContact {
  carId               Int
  customerContactId   Int
  CAR                 CAR      @relation(fields: [carId], references: [id])
  CustomerContact     CustomerContact @relation(fields: [customerContactId], references: [id])
  @@id([carId, customerContactId])
}
```

### WeeklyReport 모델

```ts
model WeeklyReport {
  id         Int      @id @default(autoincrement())
  title      String?  // 보고서 제목 [주간 요약 보고서_AI분석_yymmdd-##]
  weekStart  DateTime // unique 제약조건 제거 - 매번 새로운 보고서 생성 허용
  data       Json     // 보고서 전체 데이터(JSON)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}
```

#### data 필드 구조(예시)
```json
{
  "고객사명": {
    "evidence": "(전체 이력 기반 반복/장기/패턴 요약)",
    "summary": { "totalEvents": 12, "avgSentiment": 44.2, "scoreSum": 5 },
    "topIssues": [ { "title": "...", "plan": "...", "score": 0 }, ... ],
    "aiRecommendation": "(전략명~효과 5줄)"
  },
  ...
}
```
- evidence: 전체 이력 기반 전처리 요약/패턴/통계(서버에서 산출)
- summary: 최근 30일+미종결 CAR 집계
- topIssues: Top5 이슈(30일+미종결 기준)
- aiRecommendation: LLM 기반 전략 제언(5줄)

### managementEmail 모델

```ts
model managementEmail {
  id    Int    @id @default(autoincrement())
  email String @unique
}
```

 

---

## 3. Enum 정의

```ts
enum Role {
  ADMIN
  MANAGER
  STAFF
}

enum EventType {
  ONE_TIME
  CONTINUOUS
}

enum ReceptionChannel {
  EMAIL
  CALL
  VISIT
  OTHER
}

// enum CarStatus { ... } // 실제 구현: status enum 미사용 향후 기능 확장 고려
// EventType은 ONE_TIME, CONTINUOUS 두 가지이며,
// 고객사 필드는 드롭다운 기반이며 복수 입력된 customerContact는 ','로 분리됨
```

---

## 4. Score 계산 로직

### One-time CAR

```ts
score = subjectiveScore
```

### Continuous CAR

```ts
// 완료된 경우
score = (dateScore + internalScore + customerScore) * importance

// 미완료인 경우
score = 0
```

#### dateScore 기준표

| 지연 정도   | 점수 |
| ------- | -- |
| 기한 내 마감 | 5  |
| 1일 지연   | 3  |
| 3일 지연   | 2  |
| 1주 지연   | 0  |
| 1달 지연   | -3 |
| 1달 초과   | -5 |

---

## 5. 마이그레이션 전략

* 파일: `UPLOAD_TEMPLATE_UTF8.csv`
* 위치: `/scripts/seed.ts` 또는 Prisma CLI에서 사용
* csv-parse로 파싱, 빈 문자열은 null 처리
* 날짜: `YYYY-MM-DD`, 숫자: float 변환
* `createMany()`로 bulk insert 수행

> 모든 필드 구조는 CAR 모델 기준과 완전히 일치해야 함
 
---

## 6. AI 연동 데이터 구조 및 정책 (LLM API)

### 6.1 이슈 데이터 구조
- 각 이슈는 다음 필드를 포함: open_issue, follow_up_plan, contact, score, importance, issueDate, dueDate, completionDate 등
- contact 필드는 '이름직급' 형식, ','로 구분, 줄바꿈/공백 제거(비정상 데이터 자동 정제)
- score가 0인 항목도 반드시 포함(제외하지 않음)

### 6.2 점수 계산 정책
- one_time: score = subjectiveScore
- continuous: score = (dateScore + internalScore + customerScore) * importance
- completionDate == null → score = 0
- dateScore는 기한 내/지연 일수에 따라 산출(상세 표는 기존 4. Score 계산 로직 참고)

### 6.3 예외 및 정책
- 필수 필드 누락(이름, 점수 등) 시 "정보 부족"으로 표시, 전체 집계/요약에는 포함
- contact 필드에 줄바꿈/특수문자 등 비정상 데이터 발견 시 자동 정제(공백/줄바꿈 제거, ','로 통일)
- score가 0인 항목도 반드시 포함

---

## 7. 주간 보고서(DB) 저장 정책

- 주간 보고서(WeeklyReport)는 매주 월요일 기준으로 1건씩 저장된다.
- 보고서 생성 시, 해당 주차(weekStart) 데이터가 이미 있으면 update, 없으면 create한다.
- 보고서 데이터는 전체 JSON 구조로 저장하며, AI 전략 제언/이슈 요약 등 모든 정보를 포함한다.
- 대시보드/팝업 등에서는 항상 DB에서 최신 주간 보고서 데이터를 조회한다.
- 서버 재시작/배포와 무관하게 항상 최신/과거 데이터를 안전하게 불러올 수 있다.
- 과거 보고서 이력 관리도 가능하다(주차별 저장).

---

## 8. 필터링 및 대시보드 연동 데이터 정책

- 모든 대시보드 컴포넌트는 주간 보고서(WeeklyReport) DB 기준으로 렌더링됨
- 필터 상태는 서버 요청 시 query parameter로 전송되며, 서버는 이에 맞는 데이터 subset 반환
- 차트 필터 클릭 이벤트는 클라이언트 상태를 통해 관리되며, 기존 필터와 병합하여 API 호출
- 필터+차트 조합에 따른 쿼리 결과는 SummaryCard, Table, Chart 등에서 공유됨

---

## 9. 로그인 및 세션 관리 구조

- 사용자는 `User` 테이블에 등록된 ID로 로그인
- 로그인 성공 시 서버는 JWT를 발급하여 클라이언트에 저장 (로컬 스토리지)
- JWT는 `/api` 호출 시 인증 헤더(`Authorization: Bearer`)로 전달됨
- 세션 만료/에러 시 로그인 페이지로 강제 리디렉션 처리

---

## 10. 주요 테이블

### weeklyReport
- weekStart: Date (주간 기준일, 월요일)
- data: JSON (고객사별 summary/topIssues/aiRecommendation 포함)
  - summary: { totalEvents, avgSentiment, scoreSum }
  - topIssues: [{ title, plan, score }]
  - aiRecommendation: string (줄바꿈 5줄, 전략명~효과)

### managementEmail
- email: string (경영층 메일링 리스트)

### CAR 관련 테이블
- CAR, 고객사, 이슈, 전략 등

---

## 11. 데이터 흐름
- 보고서 생성 시 각 고객사별로 summary/topIssues/aiRecommendation 집계
- aiRecommendation은 LLM 파싱(라벨+5줄 fallback, 5줄 미만 '-' 채움)
- DB→메일/보고서/대시보드로 일관 출력

---

## 12. 데이터 흐름 및 저장 정책
- 1. 전체 CAR 이력(고객사별) 조회
- 2. 서버 전처리(evidence: 반복/장기/패턴 등 요약)
- 3. 최근 30일 신규+미종결 CAR 상세 추출
- 4. evidence+상세 이슈를 LLM(GPT-3.5)로 요약
- 5. 요약 결과를 LLM(GPT-4)로 전략 제언 생성
- 6. evidence, summary, topIssues, aiRecommendation을 WeeklyReport.data에 저장
- 7. 대시보드/메일/보고서 등에서 evidence(근거)도 함께 활용

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 운영/확장 시 PostgreSQL 등으로 전환 가능. 개발/테스트는 SQLite 권장

---