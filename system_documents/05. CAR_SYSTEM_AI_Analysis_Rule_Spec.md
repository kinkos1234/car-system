# Comad J CAR 시스템 AI 분석 규칙 정의서

> 최종 수정일: 2025-06-20
> 작성자: TECH ME Comad J
> 업데이트: 구현 완료 기준 최종본

> 이 문서는 Comad J CAR 시스템 내 AI 기반 분석에 사용되는 전체 분석 파이프라인, 점수 계산 규칙, 전처리 정책, LLM 활용 방식 등을 기술합니다.

---

## 1. 전체 분석/제언 파이프라인 (2025-06 최신)

### 1.1 분석 흐름 개요
1. **전체 CAR 이력(고객사별) 조회**
2. **서버 전처리**: 전체 이력에서 반복 이슈, 장기 미해결, 주요 트렌드 등 요약/패턴/통계 산출
3. **최근 30일 신규 + 미종결 CAR 상세 추출**
4. **전처리 근거 + 상세 이슈를 GPT-3.5로 요약**
5. **요약 결과를 GPT-4로 전략 제언 생성**
6. **DB 저장 및 대시보드/메일/보고서 활용**

### 1.2 전처리 정책
- 전체 이력은 LLM에 직접 입력하지 않고, 서버에서 반복/장기/패턴 등으로 요약
- 전처리 결과는 evidence(근거) 필드로 저장 및 프롬프트에 포함
- evidence 구조 예시
```json
"evidence": {
  "repeated": ["납기 지연", "품질 불만"],
  "longUnresolved": ["도장 공정 문제"],
  "trend": ["R&N 고객사의 품질 민원 증가"]
}
```
- 최근 30일+미종결 CAR는 상세 목록 그대로 활용
- 토큰 한계/비용 최적화 위해 Top N, 요약, 통계 등 적용 가능

### 1.3 LLM 활용 정책
- **GPT-3.5**: 전처리 근거+상세 이슈를 요약(Top5 등)
- **GPT-4**: 요약 결과와 이슈 목록을 바탕으로 전략 제언 생성
- 프롬프트 예시:
  ```
  [전체 이력 기반 요약]
  - 반복 이슈: ...
  - 장기 미해결: ...
  [최근 30일+미종결 상세]
  - 이슈1: ...
  - 이슈2: ...
  ...
  ```

### 1.4 저장 및 활용
- evidence(근거), summary, topIssues, aiRecommendation 등 구조화하여 DB(WeeklyReport, SQLite 파일 기반)에 저장
- 대시보드/메일/보고서 등에서 evidence(근거)도 함께 활용
- 예시
```json
{
  "evidence": "고객사 이슈가 반복되고 있음",
  "summary": {
    "totalEvents": 15,
    "avgSentiment": 42.3,
    "scoreSum": 7.4
  },
  "topIssues": [
    { "title": "납기 지연", "plan": "공정 개선 검토", "score": 4.2 }
  ],
  "aiRecommendation": "공급 안정화 전략\nTESLA\n납기 문제 지속\n공정 재조정 제안\n재발 방지 기대"
}
```
- 운영/확장 시 PostgreSQL 등 RDBMS로 전환 가능(확장성 고려)

### 1.5 대시보드 연동을 위한 파싱 구조 및 라벨 기준

- 각 전략 제언은 고객사 단위로 그룹핑되어 저장되며, 차트/카드/테이블 등에서 호출됨
- evidence, summary, topIssues, aiRecommendation 등은 고객사 단위 키(key)로 파싱됨
- 대시보드 필터 및 차트 선택 항목은 이 데이터 구조 내에서 하위 필터로 적용됨

### 1.6 분석 재처리 및 재요청 정책

- 동일한 기간/고객사에 대해 분석 재요청 시 기존 보고서가 덮어쓰기(update) 처리됨
- 재처리 요청은 내부 `/api/report/weekly/generate`를 수동 호출하여 수행 가능
- 전략 제언/요약 로직이 바뀐 경우, 기존 데이터와 불일치 발생 가능 (명시 필요)
- 분석 재처리 시점 및 수행자는 로그로 기록됨

---

## 2. sentimentScore 산출 기준 및 정책

### 2.1 산출 대상 및 입력
- 산출 대상: CAR의 openIssue(오픈 이슈) 텍스트
- 입력 데이터: openIssue 필드(문자열)

### 2.2 전처리 및 예외 처리
- 입력 텍스트가 비어있거나 null인 경우: sentimentScore 산출하지 않음(null 저장)
- 특수문자, 불용어 등은 사전 전처리(토큰화, 정제 등) 후 분석

### 2.3 산출 방식
- 1차(현행):
  - konlpy Okt 형태소 분석 + 자체 감정사전 기반
  - 긍정/부정 단어 출현 빈도에 따라 0~100점 스케일로 점수화
  - 예시: score = 50 + (긍정단어수 - 부정단어수) * 25 (0~100 범위 클리핑)
- 2차(고도화 예정):
  - LLM API(LLM) 기반 감성 분석
  - 입력 텍스트를 LLM에 전달, 결과를 0~100점 스케일로 변환
  - 전략적 제언(예: 개선방안, 위험요소 등)도 함께 추출 가능

### 2.4 저장 및 적용 기준
- sentimentScore는 CAR 테이블의 별도 컬럼에 저장
- CAR 등록/수정 시 자동 산출 및 저장(프론트/백엔드 중 한 곳에서 일관 적용)
- 분석/대시보드/통계 등 모든 집계에 동일 기준 적용

### 2.5 예외 및 정책
- 입력 텍스트가 너무 짧거나(예: 3자 이하), 의미 없는 경우: null 처리 또는 분석 제외
- 감성 점수 산출 실패(모델 오류 등) 시: null 처리 및 로그 기록
- 향후 LLM 기반 분석 도입 시, 기존 감정사전 방식과 결과 차이 발생 시 정책적으로 우선순위 지정

---

## 3. 감성 분석 고도화 계획

- LLM API 연동을 통한 감성 분석 및 전략적 제언 추출(기존 감정사전 방식 대체)

---

## 4. LLM API 기반 AI 분석 정책 및 예외 처리

### 4.1 분석 정책
- ChatGPT 3.5: 이슈 요약, 불필요 정보 제거, 1,500자 이내로 요약
- ChatGPT 4.5: 누적 이슈 요약, 오픈 이슈 대응 전략, 향후 대응 방향 제언(각 항목 2~3문장)
- 모든 이슈 데이터는 고객사/담당자별로 집계, 누락 없이 전송
- score가 0인 항목도 반드시 포함
- contact 필드는 '이름직급' 형식, ','로 통일(줄바꿈/공백 제거)

### 4.2 예외 및 처리 정책
- 필수 필드 누락(이름, 점수 등) 시 "정보 부족"으로 표시, 전체 집계/요약에는 포함
- contact 필드에 줄바꿈/특수문자 등 비정상 데이터 발견 시 자동 정제
- ChatGPT API 호출 실패 시 최대 2회 재시도, 2회 실패 시 "제언 생성 불가"로 표시 및 로그 기록
- 10초 이상 응답 지연 시 "AI 응답 지연 중" 안내, 20초 초과 시 실패 처리
- ChatGPT 3.5가 요약 불가(비정상 응답 등) 시, 원본 텍스트 일부만 표시(최대 500자)

### 4.3 이상 응답 및 실패 사례 예시
- 예시 1: `"응답 불가"` → ChatGPT 응답 timeout
- 예시 2: `"전략 없음"` → 오픈 이슈 없음 or 비어있는 텍스트
- 예시 3: `"-"로 채워진 전략"` → 라벨 누락 및 줄 수 부족
- 예시 4: `"500자 이하 원문 일부 표시"` → 요약 실패 fallback

모든 예외 응답은 대시보드/메일 등에서 동일하게 표시됨

---

## 5. 전략 제언 파싱/출력 규칙
- LLM 응답은 라벨 기반(예: [전략명]: ...) 또는 라벨 없는 5줄(줄바꿈) 모두 지원
- 파싱 로직은 라벨 우선, 라벨이 없으면 줄 순서대로 전략명/대상/요약/조치/예상효과에 매핑
- 응답이 전부 비어있거나 단일 문장일 경우:
   → 전체 필드에 '-' 채워넣고 '정보 부족' 표시
- 모든 전략 제언은 메일/보고서/대시보드에 5개 항목으로 일관되게 출력
- 예외 케이스(공백, 3줄, 1줄 등)도 구조적으로 대응

## 6. Top 5 이슈 요약
- LLM 프롬프트는 번호/불필요한 설명 없이 한 줄 요약 리스트로 유도
- 규칙 기반 3개 미만이면 LLM 요약 fallback

## 7. 파싱/출력 예시
- 라벨 기반: [전략명]: ... [대상]: ... [요약]: ... [조치]: ... [예상 효과]: ...
- 5줄: 전략명\n대상\n요약\n조치\n예상효과
- 3줄: 전략명\n대상\n요약 (나머지 '-')

## 8. 메일/보고서/대시보드 출력
- 모든 경로에서 5개 항목이 일관되게 출력됨을 보장

## 9. 분석 로그 및 추적 정책
- 모든 `/generate` 호출 시 요청자, 고객사, 분석 대상 기간, 요청 시간 기록
- 주요 로그 필드:
  - `requesterEmail`
  - `corp`, `customer`
  - `generatedAt`
  - `llmPromptVersion`
  - `resultStatus` (`success`, `fail`, `partial`, `fallback`)
- 서버 로그 또는 별도 DB(`WeeklyReportLog`)에 저장
- LLM 호출 실패/지연/예외 응답 시 상세 원인 함께 저장
- 재처리 수행 이력도 동일한 방식으로 기록됨

---