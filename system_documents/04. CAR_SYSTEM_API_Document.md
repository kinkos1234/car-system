# Comad J CAR 시스템 API 명세서

> 최종 수정일: 2025-06-20
> 작성자: TECH ME Comad J
> 업데이트: 구현 완료 기준 최종본

> 이 문서는 Comad J CAR 시스템에서 사용되는 주요 API 명세와 최신 AI 분석/제언 파이프라인 정책을 기술합니다.

---

## 0. 권한별 API 호출 가능 여부 요약표
| API 경로                        | ADMIN | MANAGER | STAFF  |
| ----------------------------- | ----- | ------- | ------ |
| `/api/report/weekly/generate` | ✅     | ✅       | ✅      |
| `/api/report/weekly/latest`   | ✅     | ✅       | ✅      |
| `/api/ai/*`                   | ✅     | ✅       | ✅      |
| `/api/customer/:id (DELETE)`  | ✅     | ❌       | ❌      |
| `/api/car/:id (DELETE)`       | ✅     | ✅       | 🔒 본인만 |
| `/api/admin/users`            | ✅     | ❌       | ❌      |

---

## 1. 주요 변경점 (2025-06)
- 주간 보고서 생성 API: 전체 이력 기반 evidence(근거) + 최근 30일+미종결 상세 + LLM 요약/제언 구조로 변경
- evidence, summary, topIssues, aiRecommendation 등 구조화된 데이터 반환

---

## 2. 주간 보고서 생성/조회 API (최신)

### POST `/api/auth/login`

- 목적: 사용자의 로그인 인증 및 JWT 발급
- 요청 형식:
  ```json
  {
    "email": "user@example.com",
    "password": "securepassword"
  }
```
- 응답 형식 (성공):
```json
{
  "token": "JWT-토큰값",
  "user": {
    "id": 1,
    "name": "Comad J",
    "role": "MANAGER"
  }
}
```
- 응답 형식 (실패):
```json
{
  "error": "Invalid credentials"
}
```
- 비고: 토큰은 클라이언트에서 sessionStorage에 저장됨

### POST `/api/report/weekly/generate`
- 주간 보고서(WeeklyReport) 생성 및 DB 저장
- **입력/내부 흐름:**
  1. 고객사별 전체 CAR 이력 조회
  2. 서버 전처리(evidence: 반복/장기/패턴 등 요약/통계)
  3. 최근 30일 신규+미종결 CAR 상세 추출
  4. evidence+상세 이슈를 LLM(GPT-3.5)로 요약
  5. 요약 결과를 LLM(GPT-4)로 전략 제언 생성
  6. evidence, summary, topIssues, aiRecommendation을 WeeklyReport.data에 저장
- **출력 예시 (JSON 구조):**
```json
{
  "data": {
    "VW": {
      "evidence": "전체 이력 기반 요약/패턴/통계",
      "summary": {
        "totalEvents": 12,
        "avgSentiment": 44.2,
        "scoreSum": 5
      },
      "topIssues": [
        {
          "title": "부품 공급 지연",
          "plan": "대체 공급사 계약 검토",
          "score": 4.5
        },
        {
          "title": "설계 변경 요청 증가",
          "plan": "프로세스 통합 회의 추진",
          "score": 3.8
        }
      ],
      "aiRecommendation": "1. 전략명 A: 공급 안정화 방안 검토\n2. 전략명 B: 설계 커뮤니케이션 회의 주기 설정\n..."
    },
    "TESLA": {
      "...": "..."
    }
  }
}
```
> `data`는 고객사명(key)을 기준으로 다이나믹하게 구성되며, 각 value는 structured 보고서 정보를 포함합니다.
- 기존 정책(weekStart 중복 시 update, 없으면 create) 유지
> 요청 시 taskId를 반환하며, 이후 서버 로그 통해 상태 추적 가능

### GET `/api/report/weekly/latest`
- 최신 주간 보고서(WeeklyReport) 데이터 조회
- 항상 DB에서 최신 데이터를 반환
- evidence(근거) 포함 전체 구조 반환

### GET `/api/report/weekly/latest?corp=&customer=&dept=&importance=`

- 선택된 필터값에 따라 해당 조건에 맞는 WeeklyReport 데이터를 반환함
- 모든 필터 값은 optional이며, query에 따라 subset 필터링 수행
- 차트 상호작용에서 선택된 값들도 해당 query에 포함되어야 정확한 데이터 반환 가능
- 예시 호출: `/api/report/weekly/latest?corp=AutoMaker&importance=High`

---

## 3. AI 연동 API 명세 및 정책 (llm API)

### 3.1 엔드포인트
- POST `/api/ai/summary` : 고객사/담당자별 이슈 요약 요청(이슈 배열+evidence 전달)
- POST `/api/ai/strategy` : 전략적 제언 요청(요약+evidence+오픈이슈 전달)

```json
// /api/ai/summary
{
  "customer": "VW",
  "evidence": "반복 피드백 요약...",
  "issues": [
    {
      "title": "...",
      "plan": "...",
      "score": 3.5,
      "importance": 2.0,
      ...
    }
  ]
}
```

### 3.2 동작 방식
- evidence(근거)와 상세 이슈를 함께 프롬프트에 포함
- 요약은 GPT-3.5, 전략 제언은 GPT-4에서 생성
- 모든 결과는 evidence, summary, topIssues, aiRecommendation 등 구조화하여 반환

---

## 4. 예외/에러 처리
- LLM 응답 포맷 변화, 5줄 미만, 공백 등 예외 케이스 구조적으로 대응
- evidence(근거) 누락/오류 시 fallback 정책 적용

---

## 5. 기타 API/정책
- 인증, 사용자 관리, CAR 등록/수정 등 기존 정책은 현행 유지
- status 필드는 실제 DB/코드에 존재하지 않는 `virtual field`

---

## 6. 메일 발송 관련

- 테스트 환경에서는 .env 파일의 SENDGRID_API_KEY로 인증
- 운영 환경에서는 내부 SMTP 서버 인증 후 사내메일로 전송
- 외부메일 발송은 차단되며, 발송 실패 시 로그 기록

---

## 7. 고객 정보(CustomerContact) 관리 API
| 메서드    | 경로                  | 설명        |
| --------- | --------------------- | ----------- |
| GET      | `/api/customer`       | 전체 리스트 조회 |
| GET      | `/api/customer/:id`   | 단일 조회     |
| POST     | `/api/customer`       | 신규 등록     |
| PUT      | `/api/customer/:id`   | 수정        |
| DELETE   | `/api/customer/:id`   | 삭제 (ADMIN 전용) |
> DELETE 메서드는 관리자(ADMIN)만 호출 가능하며, 호출 시 role 값을 검증하여 권한이 없으면 403 에러를 반환한다.

### GET `/api/customer`
- 등록된 모든 고객 정보 목록 조회
- 필터링 파라미터(optional): 고객사명, 부서명 등

### GET `/api/customer/:id`
- 특정 고객 정보 단건 조회

### POST `/api/customer`
- 신규 고객 정보 등록
- 요청 본문 필드:
```json
{
  "customerID": "VW-001",
  "customer": "VW",
  "department": "Engineering",
  "customerContact": "Comad J과장",
  "customerPhone": "010-1234-5678",
  "remark": "빠른 피드백 요망"
}
```

### PUT `/api/customer/:id`
- 기존 고객 정보 수정

### DELETE `/api/customer/:id`
- 고객 정보 삭제 요청
- 관리자(ADMIN) 권한에서만 호출 가능
- 일반 사용자(MANAGER, STAFF)는 이 API에 접근 불가

> 이 API는 **ADMIN 권한**에서만 호출 가능  
> MANAGER / STAFF는 해당 API에 접근 불가

---
## 8. CAR 등록/조회/수정 API

### GET `/api/car`

- 목적: 조건에 맞는 CAR 리스트 조회
- 사용처: `/car/list`, `/dashboard` 테이블 뷰
- Query Parameters:
  - `corp` (string): 법인명 (예: `AutoMaker`)
  - `customer` (string): 고객사명
  - `dept` (string): 부서명
  - `status` (string): 진행 상태 (`open`, `in_progress`, `closed`)
  - `importance` (string): 중요도 (`high`, `medium`, `low`)
  - `sort` (string): 정렬 필드 (예: `createdAt`, `score`)
  - `order` (string): 정렬 방향 (`asc`, `desc`)
  - `page` (number): 페이지 번호 (기본값: 1)
  - `limit` (number): 페이지당 항목 수 (기본값: 10)
 > `status`는 실제 DB 컬럼이 아닌 서버 내부 로직에 의해 계산되는 가상 필드입니다. (ex: `completionDate == null` → `"in_progress"`)
 
- 응답 예시:
```json
{
  "total": 124,
  "page": 2,
  "limit": 10,
  "items": [
    {
      "id": 281,
      "corp": "AutoMaker",
      "customer": "NEXCO",
      "status": "in_progress",
      "importance": "high",
      "score": 72,
      "createdAt": "2025-05-20T03:45:00Z"
    },
    ...
  ]
}
```
- 비고:
  - 필터는 조합 가능, 값 누락 시 해당 조건 미적용
  
정렬은 sort + order 조합으로 적용

페이지네이션은 total, page, limit 키로 반환

### DELETE `/api/car/:id`

- 목적: CAR 이벤트 삭제
- 권한 정책:
  - ADMIN, MANAGER: 모든 CAR 삭제 가능
  - STAFF: 본인이 작성한 CAR만 삭제 가능
- 동작 방식:
  - 삭제는 확인 모달을 거쳐 즉시 실행되며, 복구 불가능
  - 삭제 후 리스트는 새로고침 필요
- 응답 예시:
```json
{ "message": "Deleted successfully." }
```
- 권한 부족 시:
```json
{ "error": "Forbidden" }
```


---

## 9. 데이터베이스 관련
- Prisma ORM / SQLite (파일 기반 DB, 개발/테스트용)
+ // 운영/확장 시 PostgreSQL 등 RDBMS로 전환 가능(확장성 고려)

---