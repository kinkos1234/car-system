# Comad J CAR 시스템 프롬프트 전략 문서 (Cursor & Context7 MCP용)

> 최종 수정일: 2025-06-20
> 작성자: TECH ME Comad J
> 업데이트: 구현 완료 기준 최종본

> 이 문서는 Cursor AI 및 Context7 MCP 기반 자동화 개발을 위한 프롬프트 설계 전략을 정의합니다.  
> 각 기능 영역별로 Cursor가 오작동하지 않도록 문맥, 조건, 트리거 프레이즈를 명시합니다.

---

## 0. 프롬프트 명령 요약 (Trigger Index)

> ※ Trigger Phrase란?  
> Cursor/Context7에서 직접 명령을 입력할 수 있는 직관적인 지시 문장입니다.  
> 통일된 명령어 형태로 프롬프트 재사용성을 높이기 위해 별도 정리합니다.

| 영역 | 목적 | 명령어 (Trigger Phrase) |
|------|------|--------------------------|
| CAR 생성 | Prisma API 생성 | `generate car create api (prisma + typescript)` |
| 로그인 | JWT 인증 및 페이지 | `generate login page with id/pw form, jwt token, and redirection to /dashboard` |
| RBAC | 권한 분기 처리 | `generate rbac middleware with admin / manager / staff` |
| 대시보드 | 그룹 통계 API | `generate car analysis api using prisma groupBy` |
| 테이블 분석 | Top5, 지연 건 | `generate api for low score top5 and delayed completion car list` |
| Seed 데이터 | CSV 입력용 Seed 스크립트 | `generate car seed script` |
| 필터 UI | 필터 → 전역 차트 제어 | `generate dashboard filters that control chart, card, table with interactive filter logic` |

---

## 1. 최신 분석/제언 파이프라인 기반 프롬프트 설계

### 1.1 전체 구조
- **전체 CAR 이력(고객사별) → 서버 전처리(evidence: 반복/장기/패턴 요약) → 최근 30일+미종결 CAR 상세 → evidence+상세 이슈를 LLM(GPT-3.5)로 요약 → 전략 제언(GPT-4.5) → DB 저장/활용**

### 1.2 프롬프트 설계 원칙
- 프롬프트에는 반드시 `[전체 이력 기반 요약]`(evidence)와 `[최근 30일+미종결 상세]`가 모두 포함되어야 함
- evidence(근거)는 서버에서 전처리된 반복/장기/패턴 요약/통계 등
- 상세 이슈는 최근 30일 신규+미종결 CAR의 상세 목록
- 토큰 한계/비용 최적화 위해 evidence는 압축, 상세 이슈는 최대 10개 항목까지 우선순위(score + importance 기준 정렬)로 전송됩니다.

### 1.3 프롬프트 예시
- **GPT-3.5 요약용:**
  ```
  아래는 고객사 A의 전체 이력 기반 요약(근거)과 최근 30일+미종결 CAR 상세 목록입니다.
  [전체 이력 기반 요약]
  - 반복 이슈: ...
  - 장기 미해결: ...
  - 주요 트렌드: ...
  [최근 30일+미종결 상세]
  - 이슈1: ...
  - 이슈2: ...
  ...
  위 내용을 바탕으로 핵심 이슈를 5개 이내로 요약해 주세요.
  (불필요한 반복/상투적 문구 제거, 1,500자 이내)
  ```
- **GPT-4.5 전략 제언용:**
  ```
  아래는 고객사 A의 전체 이력 요약(근거)와 최근 30일+미종결 이슈 요약입니다.
  1. 지금까지의 주요 문제 경향을 요약해 주세요.
  2. 현재 오픈 이슈에 대해 우선적으로 어떤 대응이 필요할지 전략적으로 제언해 주세요.
  3. 향후 유사 이슈 예방을 위한 조치 방향을 제시해 주세요.
  (각 항목은 2~3문장 이내, 명확하고 실질적인 조언 위주)
  ---
  [근거 요약]
  {evidence}
  [이슈 요약]
  {요약 텍스트}
  ```

### 1.4 파싱/출력 정책
- evidence, summary, topIssues, aiRecommendation 등 구조화된 데이터로 파싱
- 전략 제언은 라벨 기반(예: [전략명]: ...), 5줄, 3줄 등 다양한 포맷에 구조적으로 대응
- 5줄 미만 응답은 누락 항목을 `'-'`로 채워 파싱 오류 방지 (예: 예상 효과 누락 시 자동 `'-'`)
- 모든 경로에서 evidence(근거)도 함께 출력/활용

### 1.5 예외/유연성
- LLM 응답 포맷 변화에도 evidence+상세 이슈 구조를 유지
- 프롬프트/파싱 예시, fallback 구조 명시

---

## 2. 이하 기존 프롬프트/정책(로그인, 시드, 대시보드 등)은 현행 유지

- 기존 프롬프트, 트리거, 인증 정책, 대시보드 상호작용 등은 기존 내용과 동일하게 적용
- 단, AI 분석/제언 파이프라인의 프롬프트 구조가 위와 같이 변경됨을 명시

---

## 3. 공통 전략

- Cursor는 UI, API, 모델을 동시에 구성하려는 경향이 있음 → 작업 단위 구분 필수
- 모든 코드는 TypeScript + Prisma + Next.js 기반으로 작성하도록 유도
- shadcn/ui, TailwindCSS 사용 전제
- 모든 명령은 **직관적인 trigger phrase** 기반으로 관리

---

## 4. 기본 모델 및 인증 정책

- 회원가입 기능은 존재하지 않음
- 모든 계정은 admin이 수동 발급
- 로그인 방식: ID + PW, 로그인 성공 시 JWT 발급 후 `/dashboard`로 이동

> 기본 테스트 계정:  
> ID: `admin`  
> PW: `comadj`

---

## 5. 핵심 프롬프트 목록

### 5.1 CAR 생성 API

`generate car create api (prisma + typescript)`

### 5.2 로그인 페이지 + JWT 처리

`generate login page with id/pw form, jwt token, and redirection to /dashboard`

### 5.3 권한별 미들웨어

`generate rbac middleware with admin / manager / staff`

### 5.4 대시보드용 통계 API

`generate car analysis api using prisma groupBy`

---

## 6. 페이지 컴포넌트 및 UI 구성

### 6.1 CAR 리스트 및 등록 페이지

`generate car list page (table) and create page (form) with tailwind ui`

### 6.2 대시보드 전환 탭 UI

`generate dashboard with toggle tabs for corporation / customer / person`

---

## 7. 대시보드 필터 상호작용 로직

`generate dashboard filters that control chart, card, table with interactive filter logic`

조건:  
- 카드/차트 클릭 시 해당 값 기준 추가 필터 적용  
- 상단 필터 UI는 그대로 유지됨  
- 다시 클릭 시 초기 필터로 복원

### 7.1 차트 상호작용 추가 규칙 (Chart Interaction Enhancement)

- 각 차트 요소(예: 진행상태 Pie Chart, 중요도 Bar Chart 등)는 클릭 이벤트를 가짐
- 차트 항목을 클릭하면 해당 값을 상단 필터에 **추가 필터 값으로 삽입**
- 차트 항목을 다시 클릭하면 해당 값이 필터에서 **제거됨**
- 여러 차트 항목을 병렬로 필터에 적용 가능
- 필터 상태는 UI 내 전체 데이터(카드/테이블/다른 차트)에 동기화되어 반영됨

---

## 8. 테이블 데이터 및 분석용 API

`generate api for low score top5 and delayed completion car list`

---

## 9. Seed / Migration 관련 프롬프트

`Use Node.js with Prisma (SQLite, file-based) and csv-parse to implement a seed script (`prisma/seed.ts`)  
> that reads data from `UPLOAD_TEMPLATE_UTF8.csv` and inserts records into the `CAR` table.  
Dates should be parsed from `YYYY-MM-DD` format. Empty strings should be treated as null.  
Numeric fields such as score and importance should be parsed to float.  
Use `createMany()` if possible for bulk insert.

- Trigger phrase: `generate car seed script`

---

## 10. 시스템 인증 조건 및 로그인 정책

- 이 시스템은 회원가입 기능 없이 **관리자(admin)** 가 계정을 발급함
- 기본 계정 정보는 다음과 같음:

  - ID: `admin`  
  - PW: `comadj`

- 로그인은 ID/PW 기반이며, 성공 시 JWT 토큰이 발급됨
- 로그인 성공 후 이동 경로는 `/dashboard` (Next.js 기준)

> Cursor 프롬프트 예시:  
> `generate login page with id/pw form, jwt token, and redirection to /dashboard`

---

## 11. AI 연동 프롬프트 설계 및 데이터 전송 정책 (LLM API)

### 11.1 프롬프트 설계 원칙
- ChatGPT 3.5: 이슈 요약 및 불필요 정보 제거, 1,500자 이내로 요약
- ChatGPT 4.5: 누적 이슈 요약, 오픈 이슈 대응 전략, 향후 대응 방향 제언(각 항목 2~3문장)
- 프롬프트는 명확하고 실질적인 조언 위주로 작성

### 11.2 데이터 전송 포맷
- 고객사/담당자별 이슈 목록(배열) 및 주요 필드(open_issue, follow_up_plan, contact, score, importance, issueDate, dueDate, completionDate 등)
- contact 필드는 '이름직급' 형식, ','로 구분, 줄바꿈/공백 제거
- 전송 데이터는 1,500자 이내, 초과 시 자동 분할
- 예시:
```json
{
  "company": "ABC Corp",
  "issues": [
    {
      "open_issue": "납기 지연",
      "follow_up_plan": "다음 주 고객사 컨택 예정",
      "contact": "Comad J과장",
      "score": 2.3,
      "importance": 4,
      "issueDate": "2025-05-10",
      "dueDate": "2025-05-30",
      "completionDate": null
    }
  ]
}
```

### 11.3 프롬프트 예시
- ChatGPT 3.5:
  ```
  아래는 고객사 A의 최근 이슈 목록입니다.
  각 이슈의 핵심 내용만 요약해 주세요. (불필요한 반복/상투적 문구 제거, 1,500자 이내)
  ---
  {이슈1}
  {이슈2}
  ...
  ```
- ChatGPT 4.5:
  ```
  아래는 고객사 A의 누적 이슈 요약과 현재 오픈 이슈 목록입니다.
  1. 지금까지의 주요 문제 경향을 요약해 주세요.
  2. 현재 오픈 이슈에 대해 우선적으로 어떤 대응이 필요할지 전략적으로 제언해 주세요.
  3. 향후 유사 이슈 예방을 위한 조치 방향을 제시해 주세요.
  (각 항목은 2~3문장 이내, 명확하고 실질적인 조언 위주)
  ---
  [누적 이슈 요약]
  {요약 텍스트}
  [현재 오픈 이슈]
  {이슈1}
  {이슈2}
  ...
  ```

### 11.4 정책 요약
- 프론트/백엔드는 데이터 준비/전송만 담당, 요약/정제는 ChatGPT 3.5가 전담
- 전략적 제언은 ChatGPT 4.5가 담당하며, 팝업/보고서 등 UI에 명확히 구분되어 표시
- API 연동(요약/전략적 제언 생성)은 매주 월요일 오전 8시 30분 자동 실행
- 실패/지연 시 예외처리 정책은 API 문서 참고

## 11.5 자동 실행 정책
- 요약 및 전략 제언 API는 **매주 월요일 오전 8시 30분** 자동 실행
- 실행 실패/지연 시 재시도 및 예외처리 정책은 [API 문서] 참고
- 별도 API 명세 참조: [API 문서](./04. CAR_SYSTEM_API_Document.md)


## 12. 전략 제언 프롬프트
- 라벨 기반(예: [전략명]: ...)을 기본, LLM이 라벨 없이 5줄로 응답해도 파싱 가능하도록 설계
- 예시:
  [전략명]: 내부 커뮤니케이션 프로토콜 강화  
  [대상]: 고객 대응 담당자 전체  
  [요약]: 반복되는 응답 지연 문제 발생  
  [조치]: SLA 재정의 및 응답 가이드라인 배포  
  [예상 효과]: 고객 만족도 및 NPS 상승 기대
- 5줄: 전략명\n대상\n요약\n조치\n예상효과

### 12.1 CAR 분석 → 전략 제언 흐름

[CAR 전체 이력] --전처리--> [Evidence 요약] + [30일 상세 이슈]  
→ GPT-3.5 요약 → GPT-4.5 제언 → DB 저장 → 대시보드/메일 전송


## 13. Top 5 이슈 요약 프롬프트
- 번호/불필요한 설명 없이 한 줄 요약 리스트로 유도
- 규칙 기반 3개 미만이면 LLM 요약 fallback

## 14. 파싱 구조
- 라벨 기반 우선, 없으면 줄 순서대로 5개 항목 매핑
- 5줄 미만이면 '-'로 채움

## 15. 예외/유연성
- LLM 응답 포맷 변화에도 구조적으로 대응
- 프롬프트/파싱 예시, fallback 구조 명시

## 15.1 Fallback 예시
LLM이 아래처럼 잘못 응답한 경우:
```
- 전략 제안입니다:
  - 고객의 신뢰를 유지해야 합니다.
  - 문제를 빠르게 해결합시다.
```

→ 파싱 결과:
| 전략명                       | 대상 | 요약                       | 조치         | 예상 효과             |
|----------------------------|------|----------------------------|--------------|------------------------|
| 고객의 신뢰를 유지해야 합니다 | -    | 문제를 빠르게 해결합시다 | -            | -                      |

> ※ 예외 응답이 반복되거나 구조화 파싱이 어려울 경우, 응답 본문 전체를 raw 형태로 저장하고 분석 로그에 남깁니다. 추후 관리자 확인을 통해 패턴 개선 예정입니다.

---