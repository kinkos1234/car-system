# Comad J CAR 시스템 정보 아키텍처 (최종)

> 최종 수정일: 2025-06-20
> 작성자: TECH ME Comad J
> 업데이트: 구현 완료 기준 최종본

> 이 문서는 CAR 시스템의 전체 정보 구조, 페이지 흐름, URL 매핑 및 사용자 접근 권한 구조를 정의합니다.

---

## 전체 데이터 흐름
- CAR 데이터 집계 → LLM 파싱(라벨+5줄 fallback) → DB 저장(weeklyReport 등, SQLite 파일 기반) → 메일 발송(scripts/send-weekly-report.ts) → UI/DB/메일에서 확인

## 예외/유연성
- LLM 응답 포맷 변화, 5줄 미만, 공백 등 예외 케이스 구조적으로 대응

## MJML 템플릿 구조
- mj-body width=900px, wrapper/section/column/table 모두 100% 활용
- 표는 비율 기반 width(20~40%)로 줄바꿈 최소화, padding 최소화
- PC 환경에서 시원하게 펼쳐지는 레이아웃, Outlook/Gmail 등 호환성 확보

---

## 1. 페이지 라우팅 구조 (Next.js App Router 기준)

### 1.1 기본 동작 흐름

1. **최초 접속 시 (`/`) → 로그인 페이지로 리다이렉트**
2. **로그인 성공 시 `/dashboard`로 이동 (홈/메인)**
3. **상단 혹은 사이드 내비게이션을 통해 `대시보드` 및 `CAR 목록`으로 이동**
4. **/car/customerdb: 고객정보 목록 및 삭제 버튼 (ADMIN only)**
```
app/
├── login/                  # 로그인 페이지
├── dashboard/              # 메인 대시보드 (로그인 후 이동)
├── car/
│   ├── page.tsx           # CAR 목록 페이지
│   ├── new/               # CAR 등록
│   ├── customer/          # 고객 정보 관리
│   │   ├── page.tsx       # 고객 목록
│   │   ├── new/           # 고객 등록
│   │   └── [id]/edit/     # 고객 수정
│   └── [id]/
│       ├── page.tsx       # CAR 상세 보기
│       └── edit/          # CAR 수정 (작성자 본인만)
├── customer/
│   ├── page.tsx           # 고객 목록 페이지 (별도)
│   ├── new/               # 고객 등록
│   └── [id]/
│       ├── page.tsx       # 고객 상세
│       └── edit/          # 고객 수정
├── admin/
│   ├── page.tsx           # 관리자 메인
│   ├── user/              # 사용자 관리
│   ├── ai/                # AI 관리
│   └── report/            # 보고서 관리
├── report/
│   ├── page.tsx           # 보고서 목록
│   └── [id]/              # 보고서 상세
└── page.tsx               # 루트 접근 시 /dashboard 으로 리다이렉트
```

> 테스트 또는 초기 접근 시 사용할 기본 계정 정보:
>
> * ID: `admin`
> * PW: `comadj`
>   모든 접근 제어 및 권한 분기 테스트는 이 계정 기준으로 수행됩니다.

### 1.2 로그인 페이지 (`/login`)

- 경로: `/login`
- 필드: `ID`, `Password`
- 제출 방식: `POST /api/auth/login` 호출
- 결과:
  - 성공 → JWT 발급 + `/dashboard` 리디렉션
  - 실패 → 에러 메시지 출력
- 사용자 상태가 로그인되지 않은 경우, 다른 경로 접근 시 `/login`으로 강제 이동

---

## 2. CAR 목록 페이지(`/car/list`) 상세 명세

- 필터바 구성:
  - 법인, 고객사, 부서, 상태, 중요도, 기간 선택 가능
  - 필터 변경 시 테이블 재조회, 디바운싱 적용
- 테이블:
  - 컬럼: 생성일, 고객사, 부서, 상태, 점수, 중요도
  - 정렬 가능: 생성일, 점수, 중요도, 상태
  - 페이지네이션: 기본 10건/페이지, 하단 컨트롤 제공
- 상호작용:
  - 행 클릭 시 CAR 상세보기 페이지 이동 예정 (V3)
  - “신규 등록” 버튼 → `/car/create` 이동
- 필터와 테이블 상태는 URL query로 유지되며 공유 가능

### 삭제 처리 방식
- 별도 삭제 전용 페이지(/car/[id]/delete)는 존재하지 않음
- 삭제는 /car/list 또는 /car/[id] 페이지 내 삭제 버튼 클릭 시, 모달 확인 후 즉시 처리
- 삭제 요청 시 JWT 내 role 및 작성자 ID 기준으로 백엔드에서 권한 확인
- 삭제 성공 시 테이블 또는 상세 뷰에서 해당 항목 제거됨
> 삭제 기능은 작성자 본인(STAFF 포함), MANAGER, 또는 ADMIN 권한 사용자만 수행할 수 있으며, 삭제는 리스트 페이지 또는 상세 보기에서 모달 확인 절차를 거쳐 즉시 처리됩니다.
> 삭제는 복구할 수 없으며, 별도의 휴지통 또는 되돌리기 기능은 제공되지 않습니다.

## 3. 사용자 권한 구조

| 역할      | 설명        | 권한 요약                     | 고객정보 삭제 가능 |
| ------- | --------- | ------------------------- | ---------- |
| ADMIN   | 시스템 전체 제어 | 모든 페이지 및 기능 접근 가능         | O          |
| MANAGER | 팀장 / 리더   | 사용자 관리 제외 모든 기능 가능        | O          |
| STAFF   | 일반 사용자    | **본인이 작성한 CAR에 한해 삭제 가능** | X          |


> 권한은 JWT에 포함된 `role` 값을 기준으로 서버/프론트에서 분기 처리됩니다.
> 고객 정보(CustomerContact) 삭제는 ADMIN만 가능하며, 해당 기능은 /car/customerdb 테이블 우측 삭제 버튼 클릭으로 수행됨.

---

## 4. 주요 메뉴 구성

* 로그인
* 대시보드 (홈)
* CAR 관리

  * 목록
  * 등록
  * 상세 / 수정 / 삭제
* 사용자 관리 (ADMIN 전용)

> 메뉴는 로그인 시 role에 따라 동적으로 렌더링됩니다.

---

## 5. 예외 및 상태 처리

* 권한 없는 접근 시:  `/403` 에러 처리
* 존재하지 않는 URL: `/404` 커스텀 페이지 렌더링
* 로그인 세션 만료 시 자동 로그아웃 및 `/login`으로 이동

---

## 6. URL 및 접근 권한 요약

| URL 패스                | 설명        | 접근 권한              |
| --------------------- | --------- | ------------------ |
| `/login`              | 로그인 페이지   | 전체 공개              |
| `/dashboard`          | 메인 대시보드   | 로그인 사용자 전원         |
| `/car`                | CAR 목록    | 전체                 |
| `/car/new`            | CAR 등록    | 전체 (모든 권한 접근 가능)   |
| `/car/[id]`           | CAR 상세    | 전체                 |
| `/car/[id]/edit`      | CAR 수정    | 본인만 (STAFF 포함)     |
| `/car/customer`       | 고객 정보 관리  | 전체 (삭제는 ADMIN만)    |
| `/car/customer/new`   | 고객 등록     | 전체                 |
| `/customer`           | 고객 목록     | 전체                 |
| `/customer/new`       | 고객 등록     | 전체                 |
| `/customer/[id]`      | 고객 상세     | 전체                 |
| `/customer/[id]/edit` | 고객 수정     | 전체                 |
| `/admin`              | 관리자 메인    | ADMIN 전용           |
| `/admin/user`         | 사용자 관리    | ADMIN 전용           |
| `/admin/ai`           | AI 관리     | ADMIN 전용           |
| `/admin/report`       | 보고서 관리    | ADMIN 전용           |
| `/report`             | 보고서 목록    | 전체                 |
| `/report/[id]`        | 보고서 상세    | 전체                 |


---

운영/확장 시 PostgreSQL 등 RDBMS로 전환 가능(확장성 고려)

---

## 7. 대시보드 상호작용 정책 (UI 기반)

- 상단 필터 바와 차트는 양방향 필터링 구조를 가짐
- 특정 차트 항목 클릭 → 필터 상태 변경 + 전체 뷰 리렌더링
- 필터 상태는 URL query로 유지되며, 공유된 URL로 동일 상태 접속 가능
- KPI 카드, Worst5 리스트, 전략 제언 팝업도 동일한 상태값 기준으로 렌더링됨
- 전략 제언 팝업은 고객사 요약 카드 클릭 시 트리거되며, 최신 보고서 데이터를 기준으로 evidence/summary/topIssues/aiRecommendation을 표시함

---